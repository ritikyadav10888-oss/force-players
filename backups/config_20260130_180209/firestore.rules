rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    function isSignedIn() {
      return request.auth != null;
    }

    function getUserRole() {
      let claimRole = request.auth.token.get('role', null);
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return (claimRole != null) ? claimRole.lower() : 
             ((userDoc != null && 'role' in userDoc.data) ? userDoc.data.role.lower() : 'guest');
    }

    function isOwner() {
      return isSignedIn() && (
        request.auth.token.get('role', 'guest').lower() == 'owner' || 
        request.auth.token.get('role', 'guest').lower() == 'admin' || 
        getUserRole() == 'owner' || 
        getUserRole() == 'admin'
      );
    }
    
    function isOrganizer() {
      return isSignedIn() && (
        request.auth.token.get('role', 'guest').lower() == 'organizer' || 
        getUserRole() == 'organizer'
      );
    }

    function isTournamentOrganizer(tournamentId) {
      return isOrganizer() && 
             get(/databases/$(database)/documents/tournaments/$(tournamentId)).data.organizerId == request.auth.uid;
    }

    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }

    function isValidPhone(phone) {
      return phone.matches('^[0-9]{10}$');
    }

    function isValidSize() {
      return request.resource.size < 1048576; // 1MB
    }

    // ============================================
    // COLLECTION RULES
    // ============================================

    match /users/{userId} {
      allow read: if isSignedIn() && (request.auth.uid == userId || isOwner()); 
      allow create: if isSignedIn() && (
        (request.auth.uid == userId && 
         (request.resource.data.role == 'player' || !('role' in request.resource.data)) &&
         isValidSize() &&
         (!('email' in request.resource.data) || isValidEmail(request.resource.data.email))) ||
        isOwner()
      );
      allow update: if isOwner() || (
        isSignedIn() && 
        request.auth.uid == userId && 
        isValidSize() &&
        (!('role' in request.resource.data) || request.resource.data.role == resource.data.role) &&
        (!('accessExpiryDate' in request.resource.data) || request.resource.data.accessExpiryDate == resource.data.accessExpiryDate) &&
        (!('isVerified' in request.resource.data) || request.resource.data.isVerified == resource.data.isVerified) &&
        (!('bankDetails' in request.resource.data) || isOwner()) &&
        (!('razorpayContactId' in request.resource.data) || isOwner()) &&
        (!('razorpayFundAccountId' in request.resource.data) || isOwner())
      );
      allow delete: if isOwner();
    }

    match /tournaments/{tournamentId} {
      allow read: if true;
      allow create: if isOwner() && 
                       isValidSize() &&
                       'name' in request.resource.data &&
                       'entryFee' in request.resource.data &&
                       'organizerId' in request.resource.data;
      
      allow update: if isOwner() || (
        isOrganizer() && 
        resource.data.organizerId == request.auth.uid &&
        isValidSize() &&
        (!('entryFee' in request.resource.data) || request.resource.data.entryFee == resource.data.entryFee) &&
        (!('organizerId' in request.resource.data) || request.resource.data.organizerId == resource.data.organizerId) &&
        (!('totalCollections' in request.resource.data) || request.resource.data.totalCollections == resource.data.totalCollections) &&
        (!('paidPlayerCount' in request.resource.data) || request.resource.data.paidPlayerCount == resource.data.paidPlayerCount)
      );
      
      allow delete: if isOwner();

      match /players/{playerId} {
        allow create: if isSignedIn() && 
                         isValidSize() &&
                         (!('email' in request.resource.data) || isValidEmail(request.resource.data.email)) &&
                         (!('phone' in request.resource.data) || isValidPhone(request.resource.data.phone)) &&
                         // Security: Prevent client-side payment spoofing
                         (!('paid' in request.resource.data) || request.resource.data.paid == false) &&
                         !('paymentId' in request.resource.data) &&
                         !('orderId' in request.resource.data) &&
                         !('paidAmount' in request.resource.data) &&
                         !('paidAt' in request.resource.data);
        
        allow read: if isSignedIn() && (
          isOwner() || 
          isTournamentOrganizer(tournamentId) ||
          request.auth.uid == resource.data.userId || 
          (request.auth.token.email != null && request.auth.token.email == resource.data.email)
        );

        allow update: if isOwner() || (
          isSignedIn() && 
          isValidSize() &&
          (
            isOwner() ||
            (isOrganizer() && 
             resource.data.tournamentId == tournamentId &&
             request.resource.data.paid == resource.data.paid &&
             request.resource.data.status == resource.data.status) ||
            (request.auth.uid == resource.data.userId &&
             request.resource.data.paid == resource.data.paid &&
             request.resource.data.status == resource.data.status &&
             !('paymentId' in request.resource.data) &&
             !('orderId' in request.resource.data) &&
             !('paidAmount' in request.resource.data) &&
             !('paidAt' in request.resource.data))
          )
        );
        
        allow delete: if isOwner();
      }
    }

    match /master_players/{playerEmail} {
      allow read: if isSignedIn() && (
        isOwner() ||
        request.auth.token.email == playerEmail ||
        request.auth.uid == resource.data.userId
      );
      allow create: if isSignedIn() && 
                       isValidSize() &&
                       isValidEmail(playerEmail) &&
                       (request.auth.token.email == playerEmail || request.auth.uid == request.resource.data.userId);
      allow update: if isOwner() || (
        isSignedIn() && 
        isValidSize() &&
        (request.auth.token.email == playerEmail || request.auth.uid == resource.data.userId)
      );
      allow delete: if isOwner();
    }

    match /mail/{mailId} {
      allow create: if isSignedIn() && 
                       isValidSize() &&
                       'to' in request.resource.data &&
                       (isOwner() || request.resource.data.to == request.auth.token.email);
      allow read, update, delete: if isOwner();
    }

    match /payouts/{payoutId} {
      allow create: if isOwner() && isValidSize();
      allow read: if isSignedIn() && (
        isOwner() || 
        (resource != null && request.auth.uid == resource.data.organizerId)
      );
      allow update, delete: if isOwner();
    }

    match /financial_statements/{statementId} {
      allow create: if isOwner() && isValidSize();
      allow read: if isSignedIn() && (
        isOwner() || 
        (resource != null && request.auth.uid == resource.data.organizerId)
      );
      allow update, delete: if isOwner();
    }

    match /transactions/{transactionId} {
      allow create: if false;
      allow read: if isSignedIn() && (
        isOwner() ||
        (resource != null && (
          request.auth.uid == resource.data.organizerId ||
          request.auth.uid == resource.data.playerId ||
          request.auth.token.email == resource.data.playerEmail
        ))
      );
      allow list: if isOwner();
      allow update: if false;
      allow delete: if false;
    }

    match /payment_verification_logs/{logId} {
      allow create: if false;
      allow read: if isOwner();
      allow update, delete: if false;
    }

    match /refund_logs/{logId} {
      allow create: if false;
      allow read: if isOwner();
      allow update, delete: if false;
    }

    match /processed_webhooks/{webhookId} {
      allow create, update: if false;
      allow read: if isOwner();
      allow delete: if false;
    }

    match /email_templates/{templateName} {
      allow read: if isOwner();
      allow create, update: if isOwner() && isValidSize();
      allow delete: if isOwner();
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
