rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Check if user is an Owner
    function isOwner() {
      let claimRole = request.auth.token.get('role', 'guest').lower();
      return request.auth != null && (
        claimRole == 'owner' || 
        claimRole == 'admin'
      );
    }

    // Check if user is an Organizer
    function isOrganizer() {
      let claimRole = request.auth.token.get('role', 'guest').lower();
      return request.auth != null && claimRole == 'organizer';
    }

    // Validate file size (max 10MB for documents, 5MB for images)
    function isValidFileSize() {
      return request.resource.size < 10485760; // 10MB default
    }

    function isValidImageSize() {
      return request.resource.size < 5242880; // 5MB for images
    }

    // Validate content type
    function isValidImageType() {
      return request.resource.contentType.matches('image/.*');
    }

    function isValidDocumentType() {
      return request.resource.contentType.matches('(image/.*|application/pdf)');
    }

    // Check if email matches authenticated user
    function isOwnEmail(email) {
      return request.auth != null && request.auth.token.email == email;
    }

    // Check if user is the original uploader
    function isOriginalUploader() {
      return resource != null && 
             resource.metadata.uploaderUid == request.auth.uid;
    }

    // ============================================
    // STORAGE RULES
    // ============================================

    // 1. Player Documents (Profile Photos, Aadhar Cards)
    match /players/{email}/{fileName} {
      
      // Profile Photos: Public read access
      allow read: if fileName.matches('profile_.*');
      
      // Aadhar Cards: Private - only owner, organizer, or the player themselves
      allow read: if fileName.matches('adhar_.*') && 
                     (isOwner() || 
                      isOrganizer() || 
                      isOwnEmail(email) || 
                      isOriginalUploader());

      // Write: Restricted to prevent unauthorized overwrites
      // Updated to allow anonymous users to upload if it's a new file and they are the uploader
      allow write: if request.auth != null && 
                      isValidImageSize() &&
                      isValidImageType() &&
                      (
                        isOwner() ||
                        isOrganizer() ||
                        (isOwnEmail(email) && (resource == null || isOriginalUploader())) ||
                        (resource == null && request.resource.metadata.uploaderUid == request.auth.uid)
                      );
      
      // Delete: Only Owner or original uploader
      allow delete: if isOwner() || (isOwnEmail(email) && isOriginalUploader());
    }

    // 2. Tournament Assets (Banners, Logos, Team Images)
    match /tournaments/{tournamentId}/teams/{fileName} {
      // Public read for tournament assets
      allow read: if true;
      
      // Write: Only Owner or Organizer (for their tournaments)
      // SECURITY: Note - we can't verify tournament ownership in Storage rules,
      // so we rely on Firestore rules to ensure organizerId matches
      allow write: if (isOwner() || isOrganizer()) && 
                      isValidImageSize() &&
                      isValidImageType();
      
      // Delete: Only Owner or Organizer
      allow delete: if isOwner() || isOrganizer();
    }

    // 3. Tournament General Assets (Banners, Logos, etc.)
    match /tournaments/{tournamentId}/{allPaths=**} {
      // Public read for tournament assets
      allow read: if true;
      
      // Write: Only Owner or Organizer
      allow write: if (isOwner() || isOrganizer()) && 
                      isValidImageSize() &&
                      isValidImageType();
      
      // Delete: Only Owner or Organizer
      allow delete: if isOwner() || isOrganizer();
    }

    // 4. Organizer Documents (Profile, Aadhar, PAN)
    match /organizers/{fileName} {
      // Read: Only Owner or Organizer can view organizer documents
      allow read: if (isOwner() || isOrganizer()) && isValidDocumentType();
      
      // Write: Only Owner or Organizer can upload organizer documents
      // SECURITY: Prevent arbitrary uploads to organizer folder
      allow write: if (isOwner() || isOrganizer()) && 
                      isValidFileSize() &&
                      isValidDocumentType();
      
      // Delete: Only Owner
      allow delete: if isOwner();
    }

    // 5. Email Attachments (if needed)
    match /email_attachments/{attachmentId} {
      // Only Owner can manage email attachments
      allow read, write, delete: if isOwner() && isValidFileSize();
    }

    // 6. Audit Logs / Reports (if stored in Storage)
    match /reports/{reportId} {
      // Only Owner can access reports
      allow read, write, delete: if isOwner() && isValidFileSize();
    }

    // Default: Deny all other paths (only Owner can bypass)
    match /{allPaths=**} {
      allow read, write, delete: if isOwner();
    }
  }
}
